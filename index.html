<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTML5 QR & Barcode Scanner</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121733; --text:#e7e9f3; --muted:#9aa3c7; --accent:#6ac9ff; --ok:#21d07a; --warn:#ffd166; --err:#ff5c7a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;background:radial-gradient(1200px 800px at 10% -10%,#1a2250 0%,#0b1020 45%),linear-gradient(160deg,#08122a 0%,#0b1020 60%);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(18px,2.2vw,28px);margin:0;font-weight:700;letter-spacing:0.2px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width: 940px){.grid{grid-template-columns:1fr;}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:18px;overflow:hidden}
    .card h2{font-size:16px;margin:0 0 10px 0;color:#eaf1ff}
    .card .body{padding:14px}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .toolbar .group{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:12px}
    label{font-size:12px;color:var(--muted)}
    select, button, input[type="checkbox"]{accent-color:var(--accent)}
    select, button{appearance:none;background:#0e1532;color:var(--text);border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:10px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a4a80,#163968);border-color:#1b4f88}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}

    .status{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.idle{background:#666}
    .dot.scanning{background:var(--warn)}
    .dot.active{background:var(--ok)}
    .dot.error{background:var(--err)}

    #viewport{position:relative;background:#000;aspect-ratio:16/10;border-bottom:1px solid rgba(255,255,255,.08)}
    video{width:100%;height:100%;display:block;object-fit:cover}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .mask{position:absolute;inset:0;background:radial-gradient(220px 220px at 50% 50%, transparent 60%, rgba(0,0,0,.55) 62%)}
    .guides{position:absolute;left:50%;top:50%;width:60%;max-width:520px;aspect-ratio:1;border:2px dashed rgba(255,255,255,.35);transform:translate(-50%,-50%);border-radius:16px;}

    .list{max-height:420px;overflow:auto;border-top:1px solid rgba(255,255,255,.06)}
    .row{display:grid;grid-template-columns:90px 1fr 110px;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .row strong{font-weight:600}
    .row small{color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:3px 7px;border-radius:999px;font-size:12px}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted)}
    .footer{margin-top:10px;display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .footer a{color:var(--accent);text-decoration:none}
  </style>
  <!-- ZXing (QR + multiple barcode formats) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>QR & Barcode Scanner</h1>
      <span class="pill" id="permTip">Camera permission required</span>
    </header>

    <div class="grid">
      <!-- Scanner Panel -->
      <section class="card" aria-label="Scanner">
        <div id="viewport">
          <video id="video" playsinline muted></video>
          <div class="overlay">
            <div class="mask"></div>
            <div class="guides" aria-hidden="true"></div>
          </div>
        </div>
        <div class="body">
          <div class="toolbar">
            <div class="group" style="flex:1 1 260px">
              <label for="camera">Camera</label>
              <select id="camera" title="Choose camera"></select>
            </div>
            <div class="group">
              <label for="torch">Torch</label>
              <button id="torch" class="ghost" disabled>Toggle</button>
            </div>
            <div class="group">
              <label for="beep">Beep</label>
              <input id="beep" type="checkbox" checked />
            </div>
            <div class="group">
              <label for="vibe">Vibrate</label>
              <input id="vibe" type="checkbox" checked />
            </div>
            <div class="group">
              <button id="start" class="primary">Start</button>
              <button id="stop" class="ghost" disabled>Stop</button>
            </div>
          </div>

          <div class="status"><span class="dot idle" id="led"></span><span id="statusText">Idle</span></div>

          <div class="footer">
            <div>
              <span class="muted">Reliable results via stability filter: needs 2 identical reads in a row; cooldown 5s per code.</span>
            </div>
            <div>
              <a href="#" id="clearList">Clear results</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Results Panel -->
      <section class="card" aria-label="Results">
        <div class="body">
          <h2>Results</h2>
          <div class="list" id="results" role="log" aria-live="polite" aria-relevant="additions"></div>
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  const { BrowserMultiFormatReader, NotFoundException, ChecksumException, FormatException } = ZXing;
  const codeReader = new BrowserMultiFormatReader();

  // UI refs
  const video = document.getElementById('video');
  const cameraSel = document.getElementById('camera');
  const torchBtn = document.getElementById('torch');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const resultsEl = document.getElementById('results');
  const statusText = document.getElementById('statusText');
  const led = document.getElementById('led');
  const permTip = document.getElementById('permTip');
  const clearLink = document.getElementById('clearList');
  const beepChk = document.getElementById('beep');
  const vibeChk = document.getElementById('vibe');

  let selectedDeviceId = undefined;
  let track = null; // current MediaStreamTrack
  let torchOn = false;

  // Stability filter: require N=2 consecutive identical decodes.
  const REQUIRED_STREAK = 2;
  let lastValue = null;
  let streak = 0;
  // Cooldown map so the same code isn't spammed repeatedly
  const cooldownMs = 5000;
  const lastSeen = new Map(); // key: value+format -> timestamp

  // Audio beep
  const ctx = (window.AudioContext) ? new AudioContext() : null;
  function beep() {
    if (!ctx || !beepChk.checked) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'square';
    o.frequency.value = 880;
    o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    o.start();
    o.stop(ctx.currentTime + 0.12);
  }

  function vibrate(ms=60){ if (vibeChk.checked && navigator.vibrate) navigator.vibrate(ms); }

  function setStatus(state, text){
    statusText.textContent = text;
    led.className = 'dot ' + state;
  }

  function fmtTime(d){ return d.toLocaleTimeString(); }

  function addResult({text, format}){
    const key = `${text}|${format}`;
    const now = Date.now();
    const last = lastSeen.get(key) || 0;
    if (now - last < cooldownMs) return; // still cooling down

    // render
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div><small>${fmtTime(new Date())}</small></div>
      <div>
        <strong class="mono">${escapeHtml(text)}</strong>
        <div class="muted" style="margin-top:4px;word-break:break-word">Raw: <span class="mono">${escapeHtml(text)}</span></div>
      </div>
      <div style="display:flex;justify-content:flex-end;align-items:center;gap:8px">
        <span class="tag"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M3 12h10M3 17h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> ${format}</span>
        <button class="ghost" onclick="navigator.clipboard && navigator.clipboard.writeText('${escapeAttr(text)}')">Copy</button>
      </div>`;
    resultsEl.prepend(row);
    lastSeen.set(key, now);
  }

  function escapeHtml(s){ return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeAttr(s){ return s.replace(/[\'\\]/g, c => ({"\\":"\\\\","'":"\\'"}[c])); }

  async function listCameras(){
    const devices = await BrowserMultiFormatReader.listVideoInputDevices();
    cameraSel.innerHTML = '';
    devices.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `Camera ${cameraSel.length+1}`;
      cameraSel.appendChild(opt);
    });
    if (!selectedDeviceId && devices[0]) selectedDeviceId = devices[0].deviceId;
    cameraSel.value = selectedDeviceId || '';
    cameraSel.disabled = (devices.length <= 1);
  }

  function applyTorchSupport(ms){
    if (!ms) { torchBtn.disabled = true; return; }
    track = ms.getVideoTracks()[0] || null;
    const canTorch = track && track.getCapabilities && track.getCapabilities().torch;
    torchBtn.disabled = !canTorch;
  }

  async function start(){
    try{
      setStatus('scanning','Starting camera…');
      startBtn.disabled = true; stopBtn.disabled = false;

      // Prefer environment/back camera on mobile
      const deviceId = selectedDeviceId || undefined;
      const constraints = {
        audio:false,
        video: deviceId ? { deviceId: { exact: deviceId } } : {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          focusMode: 'continuous'
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      applyTorchSupport(stream);
      permTip.style.display = 'none';

      // Reset stability state
      lastValue = null; streak = 0;

      // Start decoding from the selected device
      await codeReader.decodeFromVideoDevice(selectedDeviceId || null, video, (result, err, controls) => {
        if (result) {
          setStatus('active','Code detected');
          const value = result.getText();
          const format = result.getBarcodeFormat();

          // Stability: confirm only after REQUIRED_STREAK same values in a row
          if (value === lastValue) {
            streak++;
          } else {
            lastValue = value; streak = 1;
          }

          if (streak >= REQUIRED_STREAK) {
            addResult({ text:value, format:String(format) });
            beep(); vibrate();
            // After confirming, require another streak for same value
            streak = 0; lastValue = null;
          }
        } else if (err && !(err instanceof NotFoundException) && !(err instanceof ChecksumException) && !(err instanceof FormatException)) {
          console.warn(err);
          setStatus('error','Decode error: ' + (err.message || err));
        } else {
          setStatus('scanning','Scanning…');
        }
      });
    } catch(e){
      console.error(e);
      setStatus('error', e.name === 'NotAllowedError' ? 'Camera permission denied' : 'Camera error: ' + (e.message || e));
      startBtn.disabled = false; stopBtn.disabled = true;
      permTip.style.display = 'inline-flex';
    }
  }

  async function stop(){
    try{
      codeReader.reset();
      if (video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(t => t.stop());
      }
      video.srcObject = null; track = null; torchOn = false;
      setStatus('idle','Idle');
    } finally {
      startBtn.disabled = false; stopBtn.disabled = true; torchBtn.disabled = true;
    }
  }

  async function toggleTorch(){
    if (!track) return;
    try{
      torchOn = !torchOn;
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      torchBtn.textContent = torchOn ? 'Torch On' : 'Torch Off';
    } catch(e){ console.warn('Torch unsupported', e); }
  }

  cameraSel.addEventListener('change', async (e)=>{
    selectedDeviceId = e.target.value || undefined;
    // switch camera if currently scanning
    if (!startBtn.disabled) return; // not running
    await stop(); await start();
  });
  torchBtn.addEventListener('click', toggleTorch);
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  clearLink.addEventListener('click', (e)=>{ e.preventDefault(); resultsEl.innerHTML=''; lastSeen.clear(); });

  // Initialize
  setStatus('idle','Idle');
  navigator.mediaDevices?.getUserMedia({video:true,audio:false}).then(async s=>{
    // immediately stop; we only want permission so we can list device labels
    s.getTracks().forEach(t=>t.stop());
    permTip.style.display='none';
    await listCameras();
  }).catch(()=>{ /* permission denied until user clicks Start */ });

  // Update camera list when devices change (e.g., plug in USB cam)
  navigator.mediaDevices?.addEventListener('devicechange', listCameras);
})();
</script>
</body>
</html>

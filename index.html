<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR from Camera â€” Tesseract.js</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;color:#111}
    .card{border:1px solid #e6e6e6;border-radius:8px;padding:16px;max-width:980px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    video, canvas, img{max-width:100%;border-radius:6px}
    #videoWrap{width:100%;max-width:420px;border:1px dashed #ddd;padding:8px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fafafa;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    progress{width:100%;height:18px}
    textarea{width:100%;height:220px;padding:8px;border-radius:6px;border:1px solid #ddd}
    label{font-weight:600}
    .small{font-size:13px;color:#555}
  </style>
</head>
<body>
  <h1>OCR from Phone Camera (client-side)</h1>
  <div class="card">
    <div class="row">
      <div style="flex:1 1 360px;min-width:320px">
        <label class="small">Live camera</label>
        <div id="videoWrap">
          <video id="video" playsinline autoplay></video>
        </div>

        <div class="controls">
          <button id="startCam">Start camera</button>
          <button id="switchCam" disabled>Switch camera</button>
          <button id="snap" disabled>Capture photo</button>
          <button id="fileBtn">Upload image</button>
          <input id="file" type="file" accept="image/*" style="display:none" />
        </div>

        <div style="margin-top:12px">
          <label class="small">Preview / Captured image</label>
          <div style="margin-top:8px">
            <img id="preview" alt="preview" src="" style="max-width:320px;max-height:420px;border:1px solid #eee;padding:6px;border-radius:6px" />
          </div>
        </div>

        <div style="margin-top:12px" class="controls">
          <button id="start">Recognize</button>
          <button id="cancel" disabled>Cancel</button>
          <button id="downloadTxt" disabled>Download text</button>
        </div>

        <div style="margin-top:12px">
          <label class="small">Progress</label>
          <progress id="progress" value="0" max="1"></progress>
          <div id="progressText" class="small">Idle</div>
        </div>
      </div>

      <div style="flex:1 1 480px;min-width:320px">
        <label for="result">Recognized text</label>
        <textarea id="result" placeholder="OCR output will appear here..." readonly></textarea>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
    const { createWorker } = Tesseract;
    const video = document.getElementById('video');
    const startCamBtn = document.getElementById('startCam');
    const switchCamBtn = document.getElementById('switchCam');
    const snapBtn = document.getElementById('snap');
    const preview = document.getElementById('preview');
    const fileBtn = document.getElementById('fileBtn');
    const fileInput = document.getElementById('file');
    const startBtn = document.getElementById('start');
    const cancelBtn = document.getElementById('cancel');
    const progressEl = document.getElementById('progress');
    const progressText = document.getElementById('progressText');
    const resultEl = document.getElementById('result');
    const downloadBtn = document.getElementById('downloadTxt');

    let stream = null;
    let useFacingMode = 'environment'; // try rear camera first on phones
    let videoTracks = [];
    let worker = null;
    let cancelRequested = false;

    async function startCamera() {
      stopCamera();
      try {
        const constraints = { video: { facingMode: useFacingMode }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        videoTracks = stream.getVideoTracks();
        startCamBtn.textContent = 'Camera running';
        switchCamBtn.disabled = false;
        snapBtn.disabled = false;
      } catch (err) {
        alert('Unable to access camera: ' + err.message);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
        startCamBtn.textContent = 'Start camera';
        switchCamBtn.disabled = true;
        snapBtn.disabled = true;
      }
    }

    startCamBtn.addEventListener('click', () => {
      if (!stream) startCamera(); else stopCamera();
    });

    switchCamBtn.addEventListener('click', async () => {
      // toggle between environment and user
      useFacingMode = (useFacingMode === 'environment') ? 'user' : 'environment';
      await startCamera();
    });

    snapBtn.addEventListener('click', () => {
      if (!stream) return alert('Start camera first');
      // capture a frame to canvas
      const w = video.videoWidth;
      const h = video.videoHeight;
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      preview.src = dataUrl;
    });

    fileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => preview.src = reader.result;
      reader.readAsDataURL(f);
    });

    async function createTesseractWorker(onProgress) {
      const w = createWorker({ logger: onProgress });
      await w.load();
      await w.loadLanguage('eng');
      await w.initialize('eng');
      return w;
    }

    startBtn.addEventListener('click', async () => {
      if (!preview.src) return alert('Capture a photo with the camera or upload an image first.');
      startBtn.disabled = true;
      cancelBtn.disabled = false;
      downloadBtn.disabled = true;
      resultEl.value = '';
      progressEl.value = 0;
      progressText.textContent = 'Starting worker...';
      cancelRequested = false;

      try {
        worker = await createTesseractWorker(m => {
          if (m && typeof m.progress === 'number') progressEl.value = m.progress;
          progressText.textContent = (m && m.status) ? `${m.status} ${(m.progress||0)*100|0}%` : JSON.stringify(m);
        });

        const source = preview.src;
        const { data: { text } } = await worker.recognize(source);

        if (cancelRequested) {
          progressText.textContent = 'Canceled';
        } else {
          resultEl.value = text;
          progressText.textContent = 'Done';
          downloadBtn.disabled = false;
        }
      } catch (err) {
        console.error(err);
        progressText.textContent = 'Error: ' + (err.message || err);
        alert('OCR failed. Check console for details.');
      } finally {
        try { if (worker) await worker.terminate(); } catch(e){}
        worker = null;
        startBtn.disabled = false;
        cancelBtn.disabled = true;
      }
    });

    cancelBtn.addEventListener('click', async () => {
      cancelRequested = true;
      progressText.textContent = 'Cancel requested';
      if (worker) {
        try { await worker.terminate(); } catch(e){}
        worker = null;
      }
      startBtn.disabled = false;
      cancelBtn.disabled = true;
    });

    downloadBtn.addEventListener('click', () => {
      const text = resultEl.value;
      if (!text) return;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ocr-result.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Clean up on page unload
    window.addEventListener('pagehide', () => stopCamera());
  </script>
</body>
</html>
